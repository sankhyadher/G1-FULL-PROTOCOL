<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FULL SEQUENCE G1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
  :root { --ink:#0f172a; --muted:#6b7280; --brand:#7c3aed; --accent:#22c55e; --panel:#0b1020; }
  html,body { 
    margin:0; 
    padding:0; 
    height:100%; 
    background:#f3f4f6;  /* <-- changed to a light shade */
    color:#0f172a;        /* adjusting for better contrast on light background */
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; 
  }
  .shell { max-width:1200px; margin:0 auto; padding:20px; }
  header { display:flex; align-items:center; gap:14px; margin-bottom:14px; flex-wrap:wrap; }
  .badge { font-weight:700; font-size:14px; padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#7c3aed,#06b6d4); color:white; }
  .title { font-size:20px; font-weight:700; letter-spacing:.3px; }
  .sub { color:#6b7280; font-size:14px; }  /* Slightly darker muted for better on light background */
  .panel { background:#fff; border:1px solid #d1d5db; border-radius:16px; padding:16px; box-shadow:0 6px 24px #0002; } /* panel also lighter */
  .controls { display:flex; align-items:center; gap:12px; margin-bottom:10px; justify-content:space-between; flex-wrap:wrap; }
  .progress { flex:1 1 320px; height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; border:1px solid #d1d5db; }
  .bar { height:100%; background:linear-gradient(90deg,#22c55e,#06b6d4); width:0%; transition:width .3s ease; }
  .status { min-width:220px; font-size:14px; color:#475569; }
  .btn {
    background:linear-gradient(90deg,#7c3aed,#06b6d4);
    color:white; border:none; padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 18px #0002;
  }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  iframe.runner {
    width:100%; min-height:88vh; border:none; border-radius:14px; background:#fff; box-shadow:0 12px 40px #0002;
  }
  .hint { font-size:13px; color:#94a3b8; }
</style>
</head>
<body>
  <div class="shell">
    <header>
      <span class="badge">MEMORY RECONSOLIDATION EXPERIMENT </span>
      <div class="title">FULL PROTOCOL G1</div>
    </header>

    <div class="panel">
      <div class="controls">
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div id="status" class="status">Ready. Click “Start Flow” to begin with <b>Task 1: MEMORY RETRIEVAL</b>.</div>
        <button id="startBtn" class="btn">Start Flow</button>
      </div>
    </div>

    <div style="height:12px;"></div>
    <iframe id="stage" class="runner" title="Task Runner"></iframe>
  </div>

  <!-- =========================
       TASK 1 – MEMORY RETRIEVAL
       (Original code with a small addition to postMessage on completion)
       ========================= -->
  <template id="task1-html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Slot Machine Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #2d1a09; color: #eee; margin: 0; }
    .container { max-width: 700px; margin: 0 auto; padding: 24px; }
    .center { text-align: center; }
    .slot-machine-layout { display: flex; flex-direction: row; gap: 32px; align-items: flex-start; }
    .slot-machine { background: #3b1e00; border-radius: 24px; padding: 32px 24px 24px 24px; box-shadow: 0 8px 32px #000a; margin-bottom: 24px; flex: 3; position: relative;}
    .reels { display: flex; justify-content: center; gap: 24px; margin-bottom: 20px; }
    .reel {
      width: 100px; height: 100px; background: #fffbe6;
      border: 6px solid #bfa145; border-radius: 16px; display: flex; align-items: center; justify-content: center;
      font-size: 3rem; box-shadow: 0 2px 12px #000a, 0 0 24px #fff70066 inset;
      transition: box-shadow 0.2s;
    }
    .chips { display: flex; justify-content: center; gap: 18px; margin-bottom: 18px; }
    .chip {
      width: 56px; height: 56px; border-radius: 50%; background: #ffe066;
      border: 4px solid #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.3rem; cursor: pointer; transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 10px #000a;
      margin: 0 2px;
    }
    .chip.selected { border: 4px solid #ff3; box-shadow: 0 0 16px #fff700; }
    .shape-chip svg { width: 40px; height: 40px; }
    .spin-btn {
      background: linear-gradient(90deg, #ff2d2d 60%, #ffb300 100%);
      color: #fff; padding: 16px 40px; border: none; border-radius: 12px; font-size: 1.5rem; cursor: pointer; margin-bottom: 14px;
      box-shadow: 0 2px 8px #000a, 0 0 16px #fff70055;
      font-weight: bold;
      letter-spacing: 1px;
      transition: filter 0.2s;
    }
    .spin-btn:disabled { background: #888; filter: grayscale(0.5); }
    .message { font-size: 1.25rem; margin: 14px 0; min-height: 40px;}
    .leaderboard { background: #1a1203; border-radius: 16px; padding: 18px 16px; max-width: 260px; margin: 0; box-shadow: 0 2px 12px #000a; flex: 1;}
    .leaderboard h3 { margin: 0 0 10px 0; color: #ffd700; text-align: center; letter-spacing: 1px; }
    .leaderboard-list { list-style: none; padding: 0; margin: 0; }
    .leaderboard-list li { padding: 6px 0; font-size: 1.1rem; }
    .player { color: #fff700; font-weight: bold; background: #3b2e00; border-radius: 6px; padding: 2px 8px;}
    .sparkle-text {
      animation: sparkle-text 0.7s alternate infinite;
      text-shadow: 0 0 12px #fff700, 0 0 24px #fff70099;
    }
    @keyframes sparkle-text {
      0% { text-shadow: 0 0 12px #fff700, 0 0 24px #fff70099; }
      100% { text-shadow: 0 0 32px #fff700, 0 0 48px #fff700cc; }
    }
    @media (max-width: 900px) {
      .slot-machine-layout { flex-direction: column; }
      .leaderboard { max-width: 100%; margin-top: 24px;}
    }
  </style>
</head>
<body>
<div class="container">

  <div class="instructions" id="instructions">
    <h2>Slot Machine Game Instructions</h2>
    <ul>
            <li>You will play <b>5 rounds</b>. In each round, place your bet using casino chips, and choose a shape to bet on.</li>
      <li><b>Higher the bet, higher the risk and potential reward.</b></li>
      <li>Try to climb the leaderboard by winning more!</li>
      <li>Press the <b>SPIN</b> button to play each round.</li>
      <li>You start with <b>$2000</b> in your wallet. If you run out, you can't play further.</li>
      <li>Good luck!</li>
    
    </ul>
    <div class="center"><button class="spin-btn" onclick="startGame()">Start Game</button></div>
  </div>

  <div class="slot-machine-layout" id="gameLayout" style="display:none;">
    <div id="game" class="slot-machine">
      <div class="center">
        <h2>Slot Machine Game</h2>
        <div id="trialInfo"></div>
      </div>
      <div class="reels-bg" style="position:relative;">
        <div class="reels" id="reels"></div>
      </div>
      <div class="chips" id="chips">
        <div class="chip" data-value="1">$1</div>
        <div class="chip" data-value="5">$5</div>
        <div class="chip" data-value="10">$10</div>
        <div class="chip" data-value="20">$20</div>
      </div>
      <div class="chips" id="shapeChips" style="margin-bottom:18px;">
        <div class="chip shape-chip" data-shape="sphere" title="Bet on Sphere"></div>
        <div class="chip shape-chip" data-shape="cube" title="Bet on Cube"></div>
        <div class="chip shape-chip" data-shape="pyramid" title="Bet on Pyramid"></div>
        <div class="chip shape-chip" data-shape="cylinder" title="Bet on Cylinder"></div>
      </div>
      <div class="center" id="gameMessage"></div>
      <div class="center" style="margin-top:10px;">
        <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN</button>
      </div>
    </div>
    <div class="leaderboard" id="leaderboard">
      <h3>Leaderboard</h3>
      <ol class="leaderboard-list" id="leaderboardList"></ol>
    </div>
  </div>

  <div class="center" id="thankYou" style="display:none;">
    <h2>Thank you for playing!</h2>
    <p>Your game is complete.</p>
    <div id="timestampSummary" style="margin-top:20px; color:#ffd700; font-size:1.1em;"></div>
  </div>
</div>
<script>
const shapeSVGs = {
  'sphere': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><radialGradient id="g1" cx="50%" cy="40%" r="50%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#a3f"/></radialGradient></defs><ellipse cx="40" cy="40" rx="32" ry="32" fill="url(#g1)" stroke="#5c2a7c" stroke-width="4"/></svg>`,
  'cube': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#3a6"/></linearGradient></defs><rect x="16" y="16" width="48" height="48" rx="8" fill="url(#g2)" stroke="#2a7c5c" stroke-width="4"/></svg>`,
  'pyramid': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g3" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#a3f"/></linearGradient></defs><polygon points="40,12 68,68 12,68" fill="url(#g3)" stroke="#5c2a7c" stroke-width="4"/></svg>`,
  'cylinder': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#3a6"/></linearGradient></defs><ellipse cx="40" cy="20" rx="24" ry="10" fill="#fff" opacity="0.5"/><rect x="16" y="20" width="48" height="40" rx="24" fill="url(#g4)" stroke="#2a7c5c" stroke-width="4"/><ellipse cx="40" cy="60" rx="24" ry="10" fill="#3a6" stroke="#2a7c5c" stroke-width="4"/></svg>`
};
const allSymbols = ['sphere', 'cube', 'pyramid', 'cylinder'];
const winningCombos = [['sphere','sphere','sphere'], ['pyramid','pyramid','pyramid']];
let trialNum = 0;
let betAmount = 1;
let betShape = 'sphere';
const TOTAL_TRIALS = 5;
let leaderboard = [];

// --- Timestamp Variables ---
let startTimestamp = Date.now();
let endTimestamp = null;
console.log("Experiment Start UNIX Timestamp:", startTimestamp);

function startGame() {
  trialNum = 0;
  leaderboard = [
    {name: "You", score: 100}
  ];
  for (let i = 1; i <= 5; i++) {
    leaderboard.push({name: "Player " + i, score: 100 - i});
  }
  document.getElementById('instructions').style.display = 'none';
  document.getElementById('gameLayout').style.display = '';
  updateGameUI();
  renderLeaderboard();
  document.querySelectorAll('.chip').forEach(chip => {
    if (!chip.classList.contains('shape-chip')) {
      chip.onclick = function() {
        document.querySelectorAll('.chip').forEach(c => { if (!c.classList.contains('shape-chip')) c.classList.remove('selected'); });
        chip.classList.add('selected');
        betAmount = parseInt(chip.dataset.value);
        document.getElementById('spinBtn').disabled = false;
        document.getElementById('gameMessage').innerHTML = '';
      }
    }
  });
  renderShapeChips();
}
function renderShapeChips() {
  const chips = document.querySelectorAll('.shape-chip');
  chips.forEach(chip => {
    const shape = chip.dataset.shape;
    chip.innerHTML = shapeSVGs[shape];
    chip.onclick = function() {
      chips.forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      betShape = shape;
    }
  });
  chips[0].classList.add('selected');
  betShape = chips[0].dataset.shape;
}
function updateGameUI() {
  document.getElementById('trialInfo').innerHTML = `<b>Trial ${trialNum+1} of ${TOTAL_TRIALS}</b>`;
  renderReels(['❓','❓','❓']);
  document.getElementById('gameMessage').innerHTML = '';
  document.getElementById('spinBtn').disabled = false;
  document.querySelectorAll('.chip').forEach(chip => { if (!chip.classList.contains('shape-chip')) chip.classList.remove('selected'); });
  betAmount = 1;
  document.querySelector('.chip[data-value="1"]').classList.add('selected');
}
function renderReels(symbols) {
  const reelsDiv = document.getElementById('reels');
  reelsDiv.innerHTML = '';
  symbols.forEach(sym => {
    const div = document.createElement('div');
    div.className = 'reel';
    div.innerHTML = shapeSVGs[sym] || '';
    reelsDiv.appendChild(div);
  });
}
function renderLeaderboard() {
  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';
  leaderboard.forEach((l,i) => {
    const li = document.createElement('li');
    li.innerText = l.name + " - $" + l.score;
    if (i === 0) li.className = 'player';
    list.appendChild(li);
  });
}

// ---- SEND TIMESTAMPS TO BACKEND ----
function sendTimestampsToBackend(start, end) {
  fetch('https://your-backend-endpoint.com/api/timestamps', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      startTimestamp: start,
      endTimestamp: end
    })
  })
  .then(response => {
    if (response.ok) {
      console.log('Timestamps sent to backend successfully.');
    } else {
      console.error('Failed to send timestamps to backend.');
    }
  })
  .catch(err => {
    console.error('Error sending timestamps:', err);
  });
}

function spin() {
  document.getElementById('spinBtn').disabled = true;
  let anim = setInterval(() => {
    renderReels([
      allSymbols[Math.floor(Math.random()*allSymbols.length)],
      allSymbols[Math.floor(Math.random()*allSymbols.length)],
      allSymbols[Math.floor(Math.random()*allSymbols.length)]
    ]);
  }, 70);

  setTimeout(() => {
    clearInterval(anim);
    // Only show win combos
    let combo = winningCombos[Math.floor(Math.random()*winningCombos.length)];
    renderReels(combo);
    document.getElementById('gameMessage').innerHTML = `<span class="sparkle-text"></span>`;
    trialNum++;
    if (trialNum < TOTAL_TRIALS) {
      setTimeout(() => {
        updateGameUI();
        renderLeaderboard();
      }, 1400);
    } else {
      setTimeout(() => {
        endTimestamp = Date.now();
        console.log("Experiment End UNIX Timestamp:", endTimestamp);
        document.getElementById('gameLayout').style.display = 'none';
        document.getElementById('thankYou').style.display = '';
        // Show timestamps on thank you screen
        document.getElementById('timestampSummary').innerHTML =
          `<b>Session Start UNIX Timestamp:</b> ${startTimestamp}<br>` +
          `<b>Session End UNIX Timestamp:</b> ${endTimestamp}`;
        // Send to backend
        sendTimestampsToBackend(startTimestamp, endTimestamp);
        // >>> ADVANCE FLOW <<<
        try { parent.postMessage({type:'taskComplete', task:1}, '*'); } catch(e) {}
      }, 1400);
    }
  }, 1100);
}
window.onload = function() {
  document.getElementById('instructions').style.display = '';
  document.getElementById('gameLayout').style.display = 'none';
  document.getElementById('thankYou').style.display = 'none';
};
</script>
</body>
</html>
  </template>

  <!-- =========================
       TASK 2 – DIGIT CANCELLATION
       (Original code with postMessage in endTask)
       ========================= -->
 <template id="task2-html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Digit Cancellation & Word Fragment Completion Tasks</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #timer, #timerWord { font-size: 24px; margin: 20px; }
    #instructions { margin: 20px; }
    #grid { display: grid; grid-template-columns: repeat(10, 36px); gap: 3px; justify-content: center; margin: 20px auto; width: max-content; }
    .cell { width: 34px; height: 34px; border: 1px solid #ccc; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .marked { background: #aaf; }
    #progress { margin: 20px; }
    #result, #wordResult { font-size: 20px; color: green; margin: 20px; }
    .timestamps {
      margin-top: 1.5em;
      color: #ffd700;
      font-size: 1.1em;
      background: #0f3460;
      border-radius: 10px;
      padding: 0.7em 1.2em;
      display: inline-block;
    }
    #wordTask { margin-top: 30px; }
    #fragmentBox { font-size: 20px; margin: 20px; }
    #completionInput { font-size: 18px; padding: 6px; }
    #submitWord { font-size: 18px; padding: 6px 14px; margin-left: 7px;}
  </style>
</head>
<body>
  <h1 id="mainTitle">Digit Cancellation Task (5 Minutes)</h1>
  <div id="instructions">
    In each grid, click all instances of the digit <b id="targetDigit"></b>.<br>
    A new grid will appear every 30 seconds!
  </div>
  <div id="timer">Time left: 05:00</div>
  <div id="progress"></div>
  <div id="grid"></div>
  <div id="result"></div>

  <div id="wordTask" style="display:none;">
    <h2>Word Fragment Completion Task (5 Minutes)</h2>
    <div id="fragmentInstructions" style="margin: 20px;">
      Complete the word fragment in each box with the first valid word that comes to your mind.<br>
    </div>
    <div id="timerWord">Time left: 05:00</div>
    <div id="wordProgress"></div>
    <div id="fragmentBox"></div>
    <input type="text" id="completionInput" maxlength="16" autocomplete="off">
    <button id="submitWord">Submit</button>
    <div id="wordResult"></div>
  </div>

  <div id="timestamps" class="timestamps" style="display:none"></div>

  <script>
    // --- TIMESTAMPS ---
    let startTimestamp = Date.now(), endTimestamp = null, wordStart = null, wordEnd = null;

    // --- Digit Cancellation Variables ---
    const TOTAL_TIME = 5 * 60; // 5 minutes in seconds
    const GRID_TIME = 30; // each grid lasts 30 seconds
    const GRIDS = TOTAL_TIME / GRID_TIME; // 10 grids
    const ROWS = 10, COLS = 10;
    let timeLeft = TOTAL_TIME, gridCount = 0, foundTotal = 0, targetTotal = 0;
    let timerInterval, gridInterval, currentTarget = 0;

    // --- Word Fragment Variables ---
    const FRAGMENTS = [
      "B_L_", "CA_E", "STR__", "H_N__", "P__PLE", "C_M__", "_OUSE", "TRE_", "_AT", "_O__SE"
    ];
    const FRAG_TIME = 30; // 30s per fragment
    const FRAG_COUNT = FRAGMENTS.length;
    let fragmentIdx = 0, wordTimeLeft = FRAG_COUNT * FRAG_TIME, responses = [];
    let timerWordInterval, fragmentInterval;
    let submittedCurrentFragment = false;

    function randomDigit() { return Math.floor(Math.random() * 10); }

    function updateTimer() {
      let min = Math.floor(timeLeft / 60), sec = timeLeft % 60;
      document.getElementById('timer').textContent =
        `Time left: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function nextGrid() {
      gridCount++;
      if (gridCount > GRIDS) return;
      currentTarget = randomDigit();
      document.getElementById('targetDigit').textContent = currentTarget;
      document.getElementById('progress').textContent = `Grid ${gridCount} of ${GRIDS}`;
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      let gridTargets = 0;
      for (let i = 0; i < ROWS * COLS; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        const digit = randomDigit();
        cell.textContent = digit;
        cell.dataset.digit = digit;
        if (digit == currentTarget) gridTargets++;
        cell.addEventListener('click', function() {
          if (!cell.classList.contains('marked')) {
            if (cell.dataset.digit == currentTarget) {
              cell.classList.add('marked');
              foundTotal++;
            }
          }
        });
        grid.appendChild(cell);
      }
      targetTotal += gridTargets;
    }

    function sendTimestampsToBackend(start, end) {
      // stub for integration (optional)
    }

    function showTimestamps() {
      let box = document.getElementById('timestamps');
      box.style.display = 'inline-block';
      box.innerHTML = `<b>Section Start UNIX Timestamp:</b> ${startTimestamp}<br>
        <b>Digit Cancellation End:</b> ${endTimestamp}<br>
        <b>Word Fragment Start:</b> ${wordStart}<br>
        <b>Word Fragment End:</b> ${wordEnd}`;
    }

    function endTask() {
      clearInterval(timerInterval);
      clearInterval(gridInterval);
      document.getElementById('result').textContent =
        `Task complete! You found ${foundTotal} out of ${targetTotal} target digits.`;
      document.getElementById('grid').innerHTML = '';
      endTimestamp = Date.now();
      setTimeout(startWordFragmentTask, 1200);
    }

    function startTask() {
      updateTimer();
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) endTask();
      }, 1000);
      nextGrid();
      gridInterval = setInterval(() => { if (timeLeft > 0) nextGrid(); }, GRID_TIME * 1000);
    }

    // --- Word Fragment Completion Task ---
    function updateWordTimer() {
      let min = Math.floor(wordTimeLeft / 60), sec = wordTimeLeft % 60;
      document.getElementById('timerWord').textContent =
        `Time left: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function showFragment(idx) {
      document.getElementById('fragmentBox').textContent = FRAGMENTS[idx];
      document.getElementById('completionInput').value = '';
      document.getElementById('completionInput').focus();
      document.getElementById('wordProgress').textContent = `Fragment ${idx+1} of ${FRAG_COUNT}`;
      document.getElementById('wordResult').textContent = '';
      submittedCurrentFragment = false;
      enableInput(true);
    }

    function enableInput(enable) {
      document.getElementById('completionInput').disabled = !enable;
      document.getElementById('submitWord').disabled = !enable;
    }

    function submitCurrentWord() {
      if (!submittedCurrentFragment) {
        let response = document.getElementById('completionInput').value.trim();
        responses[fragmentIdx] = response ? response : "---";
        document.getElementById('wordResult').textContent =
          `Response saved: ${responses[fragmentIdx]}`;
        submittedCurrentFragment = true;
        enableInput(false); // lock after submit
      }
    }

    function nextFragment() {
      submitCurrentWord();
      fragmentIdx++;
      if (fragmentIdx < FRAG_COUNT) {
        showFragment(fragmentIdx);
      } else {
        endWordFragmentTask();
      }
    }

    function startWordFragmentTask() {
      document.getElementById('mainTitle').textContent = "Word Fragment Completion Task (5 Minutes)";
      document.getElementById('instructions').style.display = 'none';
      document.getElementById('result').style.display = 'none';
      document.getElementById('grid').style.display = 'none';
      document.getElementById('progress').style.display = 'none';
      document.getElementById('wordTask').style.display = 'block';
      wordStart = Date.now();
      wordTimeLeft = FRAG_COUNT * FRAG_TIME;
      fragmentIdx = 0; responses = [];
      showFragment(fragmentIdx);
      updateWordTimer();
      timerWordInterval = setInterval(() => {
        wordTimeLeft--;
        updateWordTimer();
        if (wordTimeLeft <= 0) endWordFragmentTask();
      }, 1000);
      fragmentInterval = setInterval(() => {
        nextFragment();
      }, FRAG_TIME * 1000);
    }

    function endWordFragmentTask() {
      clearInterval(timerWordInterval);
      clearInterval(fragmentInterval);
      submitCurrentWord();
      wordEnd = Date.now();
      document.getElementById('fragmentBox').innerHTML = '';
      document.getElementById('completionInput').style.display = 'none';
      document.getElementById('submitWord').style.display = 'none';
      document.getElementById('wordProgress').textContent = '';
      document.getElementById('wordResult').innerHTML =
        'Word Fragment Task complete!<br>Your responses:<br>' +
        responses.map((r,i)=>`${FRAGMENTS[i]} → <b>${r}</b>`).join("<br>");
      showTimestamps();
      sendTimestampsToBackend(wordStart, wordEnd);

      // >>> Advance the main flow to Task 3
      try { parent.postMessage({type:'taskComplete', task:2}, '*'); } catch(e) {}
    }

    document.getElementById('submitWord').onclick = submitCurrentWord;
    document.getElementById('completionInput').addEventListener('keyup', function(e){
      if (e.key === 'Enter') submitCurrentWord();
    });

    window.onload = startTask;
  </script>
</body>
</html>
  </template>

<template id="task3-html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PNS Breathing – 6 BPM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --bg:#0e1a2b;
      --ink:#e6edf5;
      --muted:#9fb3c8;
      --accent:#ff4b6e;
      --panel:#13233a;
      --ring:#183354;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .container{
      max-width:920px;
      margin:0 auto;
      padding:28px 20px 60px;
      text-align:center;
    }
    h2{
      font-size:40px;
      margin:.2rem 0 1rem;
      letter-spacing:.4px;
    }
    .instructions{
      font-size:20px;
      line-height:1.5;
      color:var(--muted);
      margin:0 auto 18px;
      max-width:860px;
    }
    audio{
      width:100%;
      margin:16px auto 28px;
      display:block;
      filter:drop-shadow(0 4px 16px rgba(0,0,0,.35));
    }
    /* The breathing circle + glow */
    .breath-circle{
      width:220px;
      height:220px;
      margin:34px auto 18px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-size:34px;
      font-weight:700;
      color:#ffdfec;
      background:radial-gradient(circle at 50% 45%, #1a2f4d 0%, #12243d 70%, #0f1f35 100%);
      box-shadow:
        0 0 0 12px rgba(255, 75, 110, .12),
        0 0 38px 12px rgba(255, 75, 110, .22),
        inset 0 0 40px rgba(255,255,255,.06);
      transition: transform .9s ease-in-out;
    }
    /* soft pulsing halo that runs continuously */
    .breath-circle::after{
      content:"";
      position:absolute;
      width:260px;
      height:260px;
      border-radius:999px;
      background:radial-gradient(circle, rgba(255,75,110,.28), transparent 60%);
      filter:blur(18px);
      z-index:-1;
      animation:halo 3s ease-in-out infinite alternate;
    }
    @keyframes halo{
      from{ opacity:.55; transform:scale(.98); }
      to  { opacity:.85; transform:scale(1.03); }
    }
    .timer{
      margin-top:10px;
      font-size:28px;
      letter-spacing:1px;
      color:#ff9fbc;
      text-shadow:0 0 18px rgba(255,75,110,.25);
    }
    button#startBtn{
      margin-top:16px;
      font-size:18px;
      padding:12px 28px;
      border:none; border-radius:12px;
      font-weight:700; letter-spacing:.3px;
      color:white; cursor:pointer;
      background:linear-gradient(90deg,#ff4b6e,#ff7ba2);
      box-shadow:0 10px 30px rgba(255,75,110,.28);
      transition:transform .06s ease, filter .2s ease;
    }
    button#startBtn:active{ transform:translateY(1px); }
    button#startBtn:disabled{ opacity:.6; cursor:not-allowed; filter:grayscale(.1); }

    .timestamps{
      margin-top:22px;
      display:inline-block;
      background:var(--panel);
      color:#ffd5e3;
      padding:.8em 1.2em;
      border-radius:12px;
      box-shadow:0 12px 34px rgba(0,0,0,.28), inset 0 0 0 1px var(--ring);
      font-size:15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Breathing Task: 6 Breaths Per Minute</h2>

    <div class="instructions">
      Please listen to <b>the music </b> and follow the breathing guide below.<br>
      Breathe in as the circle expands, and breathe out as it contracts.<br>
      Try to take <b>6 breaths per minute</b> (inhale for 5&nbsp;s, exhale for 5&nbsp;s).
    </div>

    <audio controls>
      <source src="https://dn721609.ca.archive.org/0/items/marconi-union-weightless-528hz/Marconi%20Union%20Weightless%20%28528hz%29.mp3" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>

    <div id="breathCircle" class="breath-circle">Ready?</div>
    <div class="timer" id="timer">10:00</div>
    <button id="startBtn" onclick="startTask()">Start</button>

    <div id="timestamps" class="timestamps" style="display:none"></div>
  </div>

  <script>
    // --- BEGIN TIMESTAMP ---
    let startTimestamp = Date.now();
    let endTimestamp = null;
    console.log("Breathing Task Start UNIX Timestamp:", startTimestamp);

    // --- UI handles ---
    const breathCircle = document.getElementById('breathCircle');
    const timerDisplay = document.getElementById('timer');
    const startBtn = document.getElementById('startBtn');
    const audio = document.querySelector('audio');

    // timing
    const sessionLength = 600; // 10 min
    const breathCycle = 10;    // 5 in + 5 out
    let interval, timerInterval, timeLeft = sessionLength;

    function updateTimer(){
      const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
      const s = String(timeLeft%60).padStart(2,'0');
      timerDisplay.textContent = `${m}:${s}`;
    }

    function sendTimestampsToBackend(start, end){
      // keep your local endpoint if needed; made inert here
      // fetch('http://localhost:3000/api/timestamps', { ... })
    }

    function showTimestamps(){
      const box = document.getElementById('timestamps');
      box.style.display = 'inline-block';
      box.innerHTML = `<b>Session Start UNIX Timestamp:</b> ${startTimestamp}<br>
                       <b>Session End UNIX Timestamp:</b> ${endTimestamp}`;
    }

    function startTask(){
      startBtn.disabled = true;
      timeLeft = sessionLength;
      updateTimer();
      audio.currentTime = 0;
      audio.play();

      // kick off at "Inhale" with smooth scale
      breathCircle.textContent = 'Inhale';
      breathCircle.style.transform = 'scale(1.5)';
      let cycleTick = 0;

      clearInterval(interval);
      interval = setInterval(() => {
        cycleTick = (cycleTick + 1) % breathCycle;
        if (cycleTick === 0){
          breathCircle.textContent = 'Inhale';
          breathCircle.style.transform = 'scale(1.5)';
        } else if (cycleTick === 5){
          breathCircle.textContent = 'Exhale';
          breathCircle.style.transform = 'scale(1)';
        }
      }, 1000);

      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0){
          clearInterval(interval);
          clearInterval(timerInterval);
          breathCircle.textContent = 'Done!';
          audio.pause();
          startBtn.disabled = false;

          endTimestamp = Date.now();
          console.log("Breathing Task End UNIX Timestamp:", endTimestamp);
          showTimestamps();
          sendTimestampsToBackend(startTimestamp, endTimestamp);

          // advance to next task in parent
          try { parent.postMessage({type:'taskComplete', task:3}, '*'); } catch(e) {}
        }
      }, 1000);
    }
  </script>
</body>
</html>
</template>


  <!-- =========================
       TASK 4 – TRAIL MAKING
       (Original code with postMessage in endAll)
       ========================= -->
  <template id="task4-html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trail Making Task – 10 Trail Types</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #instructions { margin: 20px; font-size: 1.1rem; }
    #timer, #total-timer { font-size: 24px; margin: 10px; }
    #result { font-size: 20px; color: green; margin: 20px; }
    #grid {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      grid-gap: 18px;
      justify-content: center;
      margin: 30px auto;
      width: max-content;
    }
    .circle-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 2px solid #333;
      font-size: 20px;
      background: #fff;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .circle-btn.correct {
      background: #aaf;
      color: #333;
      border-color: #77f;
      cursor: default;
    }
    .circle-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #history {
      margin-top: 24px;
      font-size: 18px;
      color: #444;
    }
    #history ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: inline-block;
      text-align: left;
    }
    #history li {
      margin-bottom: 4px;
    }
    #end-message {
      color: #b00;
      font-size: 22px;
      margin-top: 30px;
      font-weight: bold;
    }
    .timestamps {
      margin-top: 1.5em;
      color: #ffd700;
      font-size: 1.1em;
      background: #0f3460;
      border-radius: 10px;
      padding: 0.7em 1.2em;
      display: inline-block;
    }
    button.start-btn {
      font-size: 1.1rem;
      padding: 8px 28px;
      margin-top: 18px;
      background: #77f;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button.start-btn:hover {
      background: #55c;
    }
  </style>
</head>
<body>
  <h1>Trail Making Task</h1>
  <div id="instructions"></div>
  <div id="total-timer">Total Time Left: 10:00</div>
  <div id="timer">Round Time: 0.00 s</div>
  <div id="grid"></div>
  <div id="result"></div>
  <div id="history"></div>
  <div id="end-message"></div>
  <div id="timestamps" class="timestamps" style="display:none"></div>

  <script>
    // --- TIMESTAMP LOGIC ---
    let startTimestamp = Date.now();
    let endTimestamp = null;
    console.log("Trail Making Task Start UNIX Timestamp:", startTimestamp);

    function sendTimestampsToBackend(start, end) {
      fetch('http://localhost:3000/api/timestamps', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          startTimestamp: start,
          endTimestamp: end
        })
      })
      .then(response => {
        if (response.ok) {
          console.log('Timestamps sent to backend successfully.');
        } else {
          console.error('Failed to send timestamps to backend.');
        }
      })
      .catch(err => {
        console.error('Error sending timestamps:', err);
      });
    }

    function showTimestamps() {
      let box = document.getElementById('timestamps');
      box.style.display = 'inline-block';
      box.innerHTML = `<b>Session Start UNIX Timestamp:</b> ${startTimestamp}<br>
                       <b>Session End UNIX Timestamp:</b> ${endTimestamp}`;
    }

    // --- TRAIL DEFINITIONS ---
    const trailTypes = [
      {
        label: "Numbers 1–25",
        instructions: "Click the buttons in ascending order from <b>1</b> to <b>25</b> as quickly as possible.",
        sequence: () => Array.from({length: 25}, (_, i) => (i + 1).toString())
      },
      {
        label: "Alternating Numbers & Letters",
        instructions: "Click the buttons in alternating order: <b>1, A, 2, B, 3, C, ...</b> as quickly as possible.",
        sequence: () => {
          let arr = [];
          for (let i = 1; i <= 13; i++) {
            arr.push(i.toString());
            if (i <= 13) arr.push(String.fromCharCode(64 + i)); // A–M
          }
          return arr.slice(0, 25);
        }
      },
      {
        label: "Letters A–Y",
        instructions: "Click the buttons in alphabetical order from <b>A</b> to <b>Y</b> as quickly as possible.",
        sequence: () => Array.from({length: 25}, (_, i) => String.fromCharCode(65 + i))
      },
      {
        label: "Even Numbers 2–50",
        instructions: "Click the even numbers in order from <b>2</b> to <b>50</b> as quickly as possible.",
        sequence: () => Array.from({length: 25}, (_, i) => ((i + 1) * 2).toString())
      },
      {
        label: "Odd Numbers 1–49",
        instructions: "Click the odd numbers in order from <b>1</b> to <b>49</b> as quickly as possible.",
        sequence: () => Array.from({length: 25}, (_, i) => (i * 2 + 1).toString())
      },
      {
        label: "Reverse Numbers 25–1",
        instructions: "Click the numbers in descending order from <b>25</b> to <b>1</b> as quickly as possible.",
        sequence: () => Array.from({length: 25}, (_, i) => (25 - i).toString())
      },
      {
        label: "Reverse Letters Y–A",
        instructions: "Click the letters in reverse alphabetical order from <b>Y</b> to <b>A</b> as quickly as possible.",
        sequence: () => Array.from({length: 25}, (_, i) => String.fromCharCode(89 - i))
      },
      {
        label: "Roman Numerals I–XXV",
        instructions: "Click the Roman numerals in order from <b>I</b> to <b>XXV</b> as quickly as possible.",
        sequence: () => ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX","XXI","XXII","XXIII","XXIV","XXV"]
      },
      {
        label: "Prime Numbers (first 25)",
        instructions: "Click the prime numbers in order from <b>2</b> to <b>97</b> as quickly as possible.",
        sequence: () => ["2","3","5","7","11","13","17","19","23","29","31","37","41","43","47","53","59","61","67","71","73","79","83","89","97"]
      },
      {
        label: "Random Symbols",
        instructions: "Click the symbols in the order shown in the instructions as quickly as possible.",
        sequence: () => ["!","@","#","$","%","^","&","*","(",")","-","+","=","?","/","<",">","~","`","|","{","}","[","]","\\"]
      }
    ];

    // --- STATE ---
    const TOTAL_PLAYTIME = 10 * 60 * 1000; // 10 minutes in ms
    let currentTrail = 0;
    let allTimes = Array(trailTypes.length).fill(null);
    let started = false, startTime, timerInterval;
    let totalStartTime = Date.now();
    let totalTimerInterval;
    let timeUp = false;
    let sequence = [];
    let next = 0;

    // --- UTILS ---
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function msToMinSec(ms) {
      let sec = Math.max(0, Math.ceil(ms / 1000));
      let min = Math.floor(sec / 60);
      let rem = sec % 60;
      return `${min}:${rem.toString().padStart(2, '0')}`;
    }

    // --- TRAIL FLOW ---
    function startNextTrail() {
      if (currentTrail >= trailTypes.length) {
        endAll();
        return;
      }
      // Show instructions for the next trail
      document.getElementById('instructions').innerHTML = `
        <b>Trail ${currentTrail+1} of ${trailTypes.length}: ${trailTypes[currentTrail].label}</b><br>
        ${trailTypes[currentTrail].instructions}<br>
        <button class="start-btn" onclick="startTrail()">Start This Trail</button>
      `;
      document.getElementById('grid').innerHTML = '';
      document.getElementById('timer').textContent = 'Round Time: 0.00 s';
      document.getElementById('result').textContent = '';
    }

    function startTrail() {
      document.getElementById('instructions').innerHTML = `
        <b>Trail ${currentTrail+1} of ${trailTypes.length}: ${trailTypes[currentTrail].label}</b><br>
        ${trailTypes[currentTrail].instructions}
      `;
      createGrid();
    }

    function createGrid() {
      if (timeUp) return;
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      document.getElementById('result').textContent = '';
      document.getElementById('timer').textContent = 'Round Time: 0.00 s';
      started = false;
      sequence = trailTypes[currentTrail].sequence();
      let shuffled = shuffle(sequence.slice());
      next = 0;
      shuffled.forEach(val => {
        const btn = document.createElement('button');
        btn.className = 'circle-btn';
        btn.textContent = val;
        btn.dataset.val = val;
        btn.addEventListener('click', function() {
          if (btn.textContent === sequence[next]) {
            btn.classList.add('correct');
            btn.disabled = true;
            if (!started) {
              started = true;
              startTime = Date.now();
              timerInterval = setInterval(updateTimer, 10);
            }
            next++;
            if (next >= sequence.length) endTask();
          }
        });
        grid.appendChild(btn);
      });
    }

    function updateTimer() {
      if (started) {
        let t = (Date.now() - startTime)/1000;
        document.getElementById('timer').textContent = `Round Time: ${t.toFixed(2)} s`;
      }
    }

    function updateTotalTimer() {
      let elapsed = Date.now() - totalStartTime;
      let remaining = TOTAL_PLAYTIME - elapsed;
      document.getElementById('total-timer').textContent = `Total Time Left: ${msToMinSec(remaining)}`;
      if (remaining <= 0 && !timeUp) {
        endAll();
      }
    }

    function endTask() {
      clearInterval(timerInterval);
      let totalTime = ((Date.now() - startTime)/1000).toFixed(2);
      document.getElementById('result').textContent = `Finished! Total time: ${totalTime} seconds.`;
      allTimes[currentTrail] = totalTime;
      showHistory();
      document.querySelectorAll('.circle-btn:not(.correct)').forEach(btn => btn.disabled = true);
      setTimeout(() => {
        currentTrail++;
        startNextTrail();
      }, 1500);
    }

    function showHistory() {
      let html = `<b>Completed Trails:</b><ul>`;
      allTimes.forEach((t, i) => {
        if (t !== null) {
          html += `<li>${trailTypes[i].label}: <span style="color:green">${t} s</span></li>`;
        }
      });
      html += `</ul>`;
      document.getElementById('history').innerHTML = html;
    }

    function endAll() {
      timeUp = true;
      clearInterval(totalTimerInterval);
      document.getElementById('grid').innerHTML = '';
      document.getElementById('result').textContent = '';
      let summary = `<div id="end-message">All trails completed! Thank you for participating.<br><br>`;
      allTimes.forEach((t, i) => {
        if (t !== null)
          summary += `${trailTypes[i].label}: <b>${t} s</b><br>`;
      });
      summary += `</div>`;
      document.getElementById('end-message').innerHTML = summary;
      document.getElementById('total-timer').textContent = 'Total Time Left: 0:00';

      // --- END TIMESTAMP ---
      endTimestamp = Date.now();
      console.log("Trail Making Task End UNIX Timestamp:", endTimestamp);

      // Show timestamps on page
      showTimestamps();

      // Send to backend
      sendTimestampsToBackend(startTimestamp, endTimestamp);

      // >>> ADVANCE FLOW <<<
      try { parent.postMessage({type:'taskComplete', task:4}, '*'); } catch(e) {}
    }

    // --- INIT ---
    startNextTrail();
    totalTimerInterval = setInterval(updateTotalTimer, 250);
    updateTotalTimer();
    // Expose startTrail for button
    window.startTrail = startTrail;
  </script>
</body>
</html>
  </template>

  <!-- =========================
       TASK 5 – COUNTERCONDITIONING
       (Original code with postMessage after game end)
       ========================= -->
  <template id="task5-html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Casino Slot Machine Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ... your CSS remains unchanged ... */
    body { font-family: 'Segoe UI', Arial, sans-serif; background: radial-gradient(circle at 50% 20%, #2d1a09 0%, #1a0d04 100%); color: #eee; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .hidden { display: none !important; }
    .center { text-align: center; }
    .slot-machine-layout { display: flex; flex-direction: row; gap: 32px; align-items: flex-start; }
    .slot-machine { background: linear-gradient(135deg, #3b1e00 60%, #a67c52 100%); border-radius: 24px; padding: 32px 24px 24px 24px; box-shadow: 0 8px 32px #000a; margin-bottom: 24px; flex: 3; position: relative;}
    .slot-machine::before {
      content: ""; position: absolute; left: 0; top: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05) 20px, transparent 40px, transparent 60px);
      border-radius: 24px; pointer-events: none;
    }
    .reels { display: flex; justify-content: center; gap: 24px; margin-bottom: 20px; }
    .reel {
      width: 140px; height: 140px; background: radial-gradient(circle, #fffbe6 60%, #f1c40f 100%);
      border: 6px solid #bfa145; border-radius: 16px; display: flex; align-items: center; justify-content: center;
      font-size: 5rem; box-shadow: 0 2px 12px #000a, 0 0 24px #fff70066 inset;
      transition: box-shadow 0.2s;
    }
    .chips { display: flex; justify-content: center; gap: 18px; margin-bottom: 18px; }
    .chip {
      width: 56px; height: 56px; border-radius: 50%; background: radial-gradient(circle, #ffe066 60%, #e1b700 100%);
      border: 4px solid #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.3rem; cursor: pointer; transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 10px #000a;
      position: relative;
      margin: 0 2px;
    }
    .chip.selected { border: 4px solid #ff3; box-shadow: 0 0 16px #fff700; }
    .shape-chip svg { width: 40px; height: 40px; }
    .spin-btn {
      background: linear-gradient(90deg, #ff2d2d 60%, #ffb300 100%);
      color: #fff; padding: 16px 40px; border: none; border-radius: 12px; font-size: 1.5rem; cursor: pointer; margin-bottom: 14px;
      box-shadow: 0 2px 8px #000a, 0 0 16px #fff70055;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      transition: filter 0.2s;
    }
    .spin-btn:disabled { background: #888; filter: grayscale(0.5); }
    .total-winnings, .wallet {
      background: #222; color: #ffd700; font-size: 1.3rem; padding: 8px 32px; border-radius: 10px; margin: 0 auto 16px auto; display: inline-block; font-weight: bold; box-shadow: 0 2px 8px #000a;
      text-shadow: 0 0 6px #fff700;
    }
    .wallet { color: #00ffae; margin-left: 16px; }
    .message { font-size: 1.25rem; margin: 14px 0; min-height: 40px;}
    .nogain { color: #aaa; }
    .leaderboard { background: #1a1203; border-radius: 16px; padding: 18px 16px; max-width: 260px; margin: 0; box-shadow: 0 2px 12px #000a; flex: 1;}
    .leaderboard h3 { margin: 0 0 10px 0; color: #ffd700; text-align: center; letter-spacing: 1px; }
    .leaderboard-list { list-style: none; padding: 0; margin: 0; }
    .leaderboard-list li { padding: 6px 0; font-size: 1.1rem; }
    .player { color: #fff700; font-weight: bold; background: #3b2e00; border-radius: 6px; padding: 2px 8px;}
    .reels-bg { background: repeating-linear-gradient(135deg, #ffd70022 0 8px, #fff0 8px 16px); border-radius: 20px;
      padding: 10px; margin-bottom: 10px; position: relative;
    }
    .thumbs-down { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-size: 4rem; color: #ff2d2d; z-index: 20; }
    .thumbs-down.hidden { display: none !important; }
    .fade-screen {
      position: absolute;
      left: 0; top: 0; width: 100%; height: 100%;
      background: #000a;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.7s;
    }
    .fade-screen.active { opacity: 1; }
  </style>
</head>
<body>
<div class="container">

  <!-- PARTICIPANT INFO FORM -->
  <div id="participantForm" class="center">
    <h2>Enter Participant Info</h2>
    <form id="infoForm" onsubmit="event.preventDefault(); showInstructions();">
      <input type="text" id="participantId" placeholder="Participant ID" required><br><br>
      <input type="text" id="sessionId" placeholder="Session ID" required><br><br>
      <input type="text" id="groupNumber" placeholder="Group Number" required><br><br>
      <input type="text" id="name" placeholder="Name" required><br><br>
      <input type="number" id="age" placeholder="Age" required><br><br>
      <select id="gender" required>
        <option value="" disabled selected>Gender</option>
        <option value="female">Female</option>
        <option value="male">Male</option>
        <option value="other">Other</option>
      </select><br><br>
      <button type="submit" class="spin-btn">Continue</button>
    </form>
  </div>

  <!-- INSTRUCTIONS -->
  <div class="center hidden" id="instructions">
    <h2>Instructions</h2>
    <ul style="text-align:left; max-width:480px; margin:0 auto 24px auto; font-size:1.15rem;">
      <li>You will play <b>50 rounds</b>. In each round, place your bet using casino chips, and choose a shape to bet on.</li>
      <li><b>Higher the bet, higher the risk and potential reward.</b></li>
      <li>Try to climb the leaderboard by winning more!</li>
      <li>Press the <b>SPIN</b> button to play each round.</li>
      <li>You start with <b>$2000</b> in your wallet. If you run out, you can't play further.</li>
      <li>Good luck!</li>
    </ul>
    <button class="spin-btn" onclick="startGameFromInstructions()">Start Game</button>
  </div>

   <!-- SLOT MACHINE GAME -->
  <div class="slot-machine-layout hidden" id="gameLayout">
    <div id="game" class="slot-machine" style="position:relative;">
      <div class="center">
        <h2>Slot Machine Game</h2>
        <div id="trialInfo"></div>
      </div>
      <div>
        <span class="total-winnings" id="totalWinnings">Total Winnings: $0</span>
        <span class="wallet" id="walletDisplay">Wallet: $2000</span>
      </div>
      <div class="reels-bg" style="position:relative;">
        <div class="reels" id="reels"></div>
        <div class="thumbs-down hidden" id="thumbsDown"></div>
        <div class="fade-screen" id="fadeScreen"></div>
      </div>
      <div class="chips" id="chips">
        <div class="chip" data-value="1">$1</div>
        <div class="chip" data-value="5">$5</div>
        <div class="chip" data-value="10">$10</div>
        <div class="chip" data-value="20">$20</div>
      </div>
      <div class="chips" id="shapeChips" style="margin-bottom:18px;">
        <div class="chip shape-chip" data-shape="sphere" title="Bet on Sphere"></div>
        <div class="chip shape-chip" data-shape="cube" title="Bet on Cube"></div>
        <div class="chip shape-chip" data-shape="pyramid" title="Bet on Pyramid"></div>
        <div class="chip shape-chip" data-shape="cylinder" title="Bet on Cylinder"></div>
      </div>
      <div class="center" id="gameMessage"></div>
      <div class="center" style="margin-top:10px;">
        <button class="spin-btn" id="spinBtn" onclick="spin()">SPIN</button>
      </div>
      <audio id="lossSound" src="https://orangefreesounds.com/wp-content/uploads/2023/10/Loss-sound-effect.mp3"></audio>
    </div>
    <div class="leaderboard" id="leaderboard">
      <h3>Leaderboard</h3>
      <ol class="leaderboard-list" id="leaderboardList"></ol>
    </div>
  </div>

</div>
<script>
const shapeSVGs = {
  'sphere': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><radialGradient id="g1" cx="50%" cy="40%" r="50%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#a3f"/></radialGradient></defs><ellipse cx="40" cy="40" rx="32" ry="32" fill="url(#g1)" stroke="#5c2a7c" stroke-width="4"/></svg>`,
  'cube': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#3a6"/></linearGradient></defs><rect x="16" y="16" width="48" height="48" rx="8" fill="url(#g2)" stroke="#2a7c5c" stroke-width="4"/></svg>`,
  'pyramid': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g3" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#a3f"/></linearGradient></defs><polygon points="40,12 68,68 12,68" fill="url(#g3)" stroke="#5c2a7c" stroke-width="4"/></svg>`,
  'cylinder': `<svg width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="g4" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#3a6"/></linearGradient></defs><ellipse cx="40" cy="20" rx="24" ry="10" fill="#fff" opacity="0.5"/><rect x="16" y="20" width="48" height="40" rx="24" fill="url(#g4)" stroke="#2a7c5c" stroke-width="4"/><ellipse cx="40" cy="60" rx="24" ry="10" fill="#3a6" stroke="#2a7c5c" stroke-width="4"/></svg>`
};
const allSymbols = ['sphere', 'cube', 'pyramid', 'cylinder'];
const noGainCombos = [['cube','cube','cube'], ['cylinder','cylinder','cylinder']];
const lossSymbols = ['sphere', 'pyramid'];

let participant = {
  participantId: '', sessionId: '', groupNumber: '',
  name: '', age: '', gender: '',
  likedShapes: [],
  bisbas: {},
  bisbasScores: {},
  trials: [],
  totalWinnings: 0,
  eventLog: [] // Array to store all event timestamps
};
let trialOrder = [];
let trialNum = 0;
let betAmount = 1;
let betShape = 'sphere';
let leaderboard = [];
let totalWinnings = 0;
let wallet = 2000;

// Utility function to log events in UNIX ms
function logEvent(event, extra={}) {
  participant.eventLog.push({
    event,
    timestamp: Date.now(),
    ...extra
  });
}

// Log experiment start
logEvent('experiment_start');

// Download data as JSON at the end
function downloadDataFile() {
  const data = {
    participantInfo: {
      participantId: participant.participantId,
      sessionId: participant.sessionId,
      groupNumber: participant.groupNumber,
      name: participant.name,
      age: participant.age,
      gender: participant.gender
    },
    trials: participant.trials,
    eventLog: participant.eventLog
  };
  const filename = `participant_${participant.participantId || 'unknown'}_data.json`;
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
  const dlAnchorElem = document.createElement('a');
  dlAnchorElem.setAttribute("href", dataStr);
  dlAnchorElem.setAttribute("download", filename);
  document.body.appendChild(dlAnchorElem);
  dlAnchorElem.click();
  dlAnchorElem.remove();
  logEvent('data_downloaded');
}

function saveParticipantInfo() {
  participant.participantId = document.getElementById('participantId').value;
  participant.sessionId = document.getElementById('sessionId').value;
  participant.groupNumber = document.getElementById('groupNumber').value;
  participant.name = document.getElementById('name').value;
  participant.age = document.getElementById('age').value;
  participant.gender = document.getElementById('gender').value;
  logEvent('participant_info_submitted', {
    participantId: participant.participantId,
    sessionId: participant.sessionId,
    groupNumber: participant.groupNumber,
    name: participant.name,
    age: participant.age,
    gender: participant.gender
  });
  document.getElementById('participantForm').classList.add('hidden');
  startGame();
}
function showInstructions() {
  // Save participant info here if needed
  participant.participantId = document.getElementById('participantId').value;
  participant.sessionId = document.getElementById('sessionId').value;
  participant.groupNumber = document.getElementById('groupNumber').value;
  participant.name = document.getElementById('name').value;
  participant.age = document.getElementById('age').value;
  participant.gender = document.getElementById('gender').value;
  logEvent('instructions_shown');
  document.getElementById('participantForm').classList.add('hidden');
  document.getElementById('instructions').classList.remove('hidden');
}

function startGameFromInstructions() {
  logEvent('game_started');
  document.getElementById('instructions').classList.add('hidden');
  document.getElementById('gameLayout').classList.remove('hidden');
  startGame(); // your existing function to initialize the game
}

// Generate trial order: first 4 and last 4 are loss, 30% of the rest are no gain, rest are loss
function generateTrialOrder() {
  const TOTAL_TRIALS = 50; // Change to 110 for your real experiment
  const EDGE_LOSS = 4;
  const MIDDLE = TOTAL_TRIALS - 2 * EDGE_LOSS;
  const NO_GAIN_TRIALS = Math.round(MIDDLE * 0.3);
  let order = [];
  for(let i=0;i<EDGE_LOSS;i++) order.push('loss');
  let middle = [];
  for(let i=0;i<NO_GAIN_TRIALS;i++) middle.push('nogain');
  while(middle.length < MIDDLE) middle.push('loss');
  for(let i=middle.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [middle[i],middle[j]] = [middle[j],middle[i]];
  }
  order = order.concat(middle);
  for(let i=0;i<EDGE_LOSS;i++) order.push('loss');
  return order;
}

function startGame() {
  trialOrder = generateTrialOrder();
  trialNum = 0;
  totalWinnings = 0;
  participant.trials = [];
  participant.totalWinnings = 0;
  wallet = 2000;
  leaderboard = Array.from({length: 15}, (_,i) => ({
    name: "Player " + (i+1), score: Math.floor(Math.random()*200+50)
  }));
  leaderboard.unshift({name: participant.name || "You", score: 0});
  document.getElementById('gameLayout').classList.remove('hidden');
  updateGameUI();
  renderLeaderboard();
  document.querySelectorAll('.chip').forEach(chip => {
    if (!chip.classList.contains('shape-chip')) {
      chip.onclick = function() {
        document.querySelectorAll('.chip').forEach(c => { if (!c.classList.contains('shape-chip')) c.classList.remove('selected'); });
        chip.classList.add('selected');
        betAmount = parseInt(chip.dataset.value);
        if (wallet < betAmount) {
          document.getElementById('spinBtn').disabled = true;
          document.getElementById('gameMessage').innerHTML = `<span class="nogain">Insufficient funds to bet. Game over!</span>`;
        } else {
          document.getElementById('spinBtn').disabled = false;
          document.getElementById('gameMessage').innerHTML = '';
        }
      }
    }
  });
  renderShapeChips();
}
function renderShapeChips() {
  const chips = document.querySelectorAll('.shape-chip');
  chips.forEach(chip => {
    const shape = chip.dataset.shape;
    chip.innerHTML = shapeSVGs[shape];
    chip.onclick = function() {
      chips.forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      betShape = shape;
    }
  });
  chips[0].classList.add('selected');
  betShape = chips[0].dataset.shape;
}
function updateGameUI() {
  document.getElementById('trialInfo').innerHTML = `<b>Trial ${trialNum+1} of 50</b>`;
  renderReels(['sphere','cube','pyramid']);
  document.getElementById('gameMessage').innerHTML = '';
  document.getElementById('spinBtn').disabled = false;
  document.getElementById('totalWinnings').innerText = `Total Winnings: $${totalWinnings}`;
  document.getElementById('walletDisplay').innerText = `Wallet: $${wallet}`;
  document.querySelectorAll('.chip').forEach(chip => { if (!chip.classList.contains('shape-chip')) chip.classList.remove('selected'); });
  betAmount = 1;
  document.querySelector('.chip[data-value="1"]').classList.add('selected');
  if (wallet < betAmount) {
    document.getElementById('spinBtn').disabled = true;
    document.getElementById('gameMessage').innerHTML = `<span class="nogain">Insufficient funds to bet. Game over!</span>`;
  }
}
function renderReels(symbols) {
  const reelsDiv = document.getElementById('reels');
  reelsDiv.innerHTML = '';
  symbols.forEach(sym => {
    const div = document.createElement('div');
    div.className = 'reel';
    div.innerHTML = shapeSVGs[sym] || '';
    reelsDiv.appendChild(div);
  });
}
function renderLeaderboard() {
  let player = leaderboard.find(l => l.name === (participant.name || "You"));
  let losses = participant.trials.filter(t => t.outcome === 'loss').length;
  leaderboard = leaderboard.filter(l => l !== player);
  let newPos = Math.min(losses, leaderboard.length);
  leaderboard.splice(newPos, 0, player);
  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';
  leaderboard.forEach((l,i) => {
    const li = document.createElement('li');
    li.innerText = l.name + " - $" + l.score;
    if (l.name === player.name) li.className = 'player';
    list.appendChild(li);
  });
}
function showThumbsDown() {
  const td = document.getElementById('thumbsDown');
  td.innerHTML = '👎';
  td.classList.remove('hidden');
  setTimeout(()=>{ td.classList.add('hidden'); }, 1000);
}
function fadeScreen() {
  const fade = document.getElementById('fadeScreen');
  fade.classList.add('active');
  setTimeout(() => fade.classList.remove('active'), 900);
}
function playLossSound() {
  const snd = document.getElementById('lossSound');
  snd.currentTime = 0;
  snd.play();
}

function spin() {
  if (wallet < betAmount) {
    document.getElementById('gameMessage').innerHTML = `<span class="nogain">Insufficient funds to bet. Game over!</span>`;
    document.getElementById('spinBtn').disabled = true;
    return;
  }
  document.getElementById('spinBtn').disabled = true;
  let spinStart = Date.now();
  logEvent('spin_started', {trial: trialNum+1, bet: betAmount, betShape: betShape, spinStartTimestamp: spinStart});
  wallet -= betAmount;
  document.getElementById('walletDisplay').innerText = `Wallet: $${wallet}`;

  let anim = setInterval(() => {
    renderReels([
      allSymbols[Math.floor(Math.random()*allSymbols.length)],
      allSymbols[Math.floor(Math.random()*allSymbols.length)],
      allSymbols[Math.floor(Math.random()*allSymbols.length)]
    ]);
  }, 70);

  setTimeout(() => {
    clearInterval(anim);
    let outcome = trialOrder[trialNum];
    let combo, message = '', isReward = 0, shapeWin = false, winAmount = 0;

    if (outcome === 'nogain') {
      combo = noGainCombos[Math.floor(Math.random()*noGainCombos.length)];
      wallet += betAmount; // Refund
      message = `<span class="nogain">No gain, no loss. Your bet is returned.</span>`;
      isReward = 0;
    } else {
      // LOSS: only sphere and pyramid allowed
      let possible = [];
      for(let a of lossSymbols)
        for(let b of lossSymbols)
          for(let c of lossSymbols)
            if (!(a==='cube'&&b==='cube'&&c==='cube') && !(a==='cylinder'&&b==='cylinder'&&c==='cylinder'))
              possible.push([a,b,c]);
      combo = possible[Math.floor(Math.random()*possible.length)];
      totalWinnings -= betAmount;
      participant.totalWinnings = totalWinnings;
      message = `<span class="nogain">You lost! <b>👎</b> Better luck next time.</span>`;
      isReward = 0;
      showThumbsDown();
      fadeScreen();
      playLossSound();
    }
    renderReels(combo);

    if (betShape && combo.includes(betShape)) shapeWin = true;
       document.getElementById('gameMessage').innerHTML = message;

    // Store backend data with 'loss' column, reactionTime, latency, and UNIX timestamps
    let spinEnd = Date.now();
    let reactionTime = spinEnd - spinStart;
    let latency = reactionTime;
    participant.trials.push({
      trial: trialNum+1,
      bet: betAmount,
      betShape: betShape,
      shapeWin: shapeWin,
      combo: combo.join(''),
      outcome: outcome,
      loss: outcome === "loss" ? betAmount : 0,
      totalWinnings: totalWinnings,
      wallet: wallet,
      reactionTime: reactionTime,
      latency: latency,
      spinStartTimestamp: spinStart,
      spinEndTimestamp: spinEnd
    });

    logEvent('spin_ended', {trial: trialNum+1, outcome: outcome, combo: combo, shapeWin: shapeWin, spinEndTimestamp: spinEnd});

    renderLeaderboard();

    trialNum++;
    if (trialNum < trialOrder.length && wallet > 0) {
      setTimeout(() => {
        updateGameUI();
        renderLeaderboard();
      }, 1600);
    } else {
      setTimeout(() => {
        logEvent('game_ended', {finalTrial: trialNum});
        document.getElementById('gameLayout').classList.add('hidden');
        downloadDataFile();
        alert("Game over! Thank you for playing.\nYour data file has been downloaded.");
        // >>> ADVANCE FLOW <<<
        try { parent.postMessage({type:'taskComplete', task:5}, '*'); } catch(e) {}
      }, 1600);
    }
  }, 1100);
}
</script>
</body>
</html>
  </template>

  <!-- =========================
       TASK 6 – SNS (Cold Pressor)
       (Original code with postMessage when finished)
       ========================= -->
  <template id="task6-html">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cold Pressor Task</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #19335c; 
      color: #fff; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      min-height: 100vh; 
      margin: 0; 
    }
    .container {
      background: #355c7d;
      padding: 2em 3em;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.2);
      text-align: center;
    }
    .timer {
      font-size: 2em;
      margin: 1em 0;
      letter-spacing: 0.1em;
      color: #ffd700;
    }
    button {
      padding: 0.7em 2.2em;
      font-size: 1.2em;
      background: #ffd700;
      color: #19335c;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1em;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:disabled {
      background: #aaa;
      color: #666;
      cursor: default;
    }
    .timestamps {
      margin-top: 1.5em;
      color: #ffd700;
      font-size: 1.1em;
      background: #2a3a5c;
      border-radius: 10px;
      padding: 0.7em 1.2em;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Cold Pressor Task</h2>
    <div id="instructions">
      <p>
        <b>Instructions:</b><br>
        When you are ready, click <b>Start</b> and immerse your hand in ice-cold water.<br>
        Keep your hand in the water until the timer reaches zero (2 minutes).<br>
        Remove your hand if you feel too uncomfortable.<br>
        Press <b>Start</b> to begin.
      </p>
    </div>
    <div class="timer" id="timer">02:00</div>
    <button id="startBtn" onclick="startTask()">Start</button>
    <div id="doneMsg" style="display:none; margin-top:1em;">
      <b>Task complete! You may remove your hand from the water.</b>
    </div>
    <div id="timestamps" class="timestamps" style="display:none"></div>
  </div>
  <script>
    let timerDisplay = document.getElementById('timer');
    let startBtn = document.getElementById('startBtn');
    let doneMsg = document.getElementById('doneMsg');
    let timestampsDiv = document.getElementById('timestamps');
    let interval;
    let duration = 2 * 60; // 2 minutes in seconds
    let timeLeft = duration;
    let startTimestamp = null;
    let endTimestamp = null;

    function updateTimer() {
      let min = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      let sec = String(timeLeft % 60).padStart(2, '0');
      timerDisplay.textContent = `${min}:${sec}`;
    }

    function showTimestamps() {
      timestampsDiv.style.display = 'inline-block';
      timestampsDiv.innerHTML = `<b>Task Start UNIX Timestamp:</b> ${startTimestamp}<br>
                                 <b>Task End UNIX Timestamp:</b> ${endTimestamp}`;
    }

    function startTask() {
      startBtn.disabled = true;
      doneMsg.style.display = 'none';
      timeLeft = duration;
      updateTimer();
      startTimestamp = Date.now();
      console.log("Cold Pressor Task Start UNIX Timestamp:", startTimestamp);
      interval = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
          clearInterval(interval);
          endTimestamp = Date.now();
          console.log("Cold Pressor Task End UNIX Timestamp:", endTimestamp);
          doneMsg.style.display = 'block';
          showTimestamps();
          // Optionally send to backend:
          // sendTimestampsToBackend(startTimestamp, endTimestamp);
          startBtn.disabled = false;
          startBtn.textContent = "Restart";
          // >>> FLOW COMPLETE <<<
          try { parent.postMessage({type:'taskComplete', task:6}, '*'); } catch(e) {}
        }
      }, 1000);
    }

    // Optional: send timestamps to backend
    /*
    function sendTimestampsToBackend(start, end) {
      fetch('http://localhost:3000/api/timestamps', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          startTimestamp: start,
          endTimestamp: end
        })
      })
      .then(response => {
        if (response.ok) {
          console.log('Timestamps sent to backend successfully.');
        } else {
          console.error('Failed to send timestamps to backend.');
        }
      })
      .catch(err => {
        console.error('Error sending timestamps:', err);
      });
    }
    */
  </script>
</body>
</html>
  </template>

  <script>
    // Runner orchestrator
    const tasks = [
      { id: 'task1-html', label: '1. MEMORY RETRIEVAL TASK' },
      { id: 'task2-html', label: '2. DIGIT CANCELLATION TASK' },
      { id: 'task3-html', label: '3. PNS TASK (6 BPM Breathing)' },
      { id: 'task4-html', label: '4. TRAIL MAKING TASK' },
      { id: 'task5-html', label: '5. COUNTERCONDITIONING TASK' },
      { id: 'task6-html', label: '6. SNS TASK (Cold Pressor)' }
    ];

    const frame = document.getElementById('stage');
    const startBtn = document.getElementById('startBtn');
    const status = document.getElementById('status');
    const bar = document.getElementById('bar');

    let idx = -1;

    function loadTask(i) {
      const t = tasks[i];
      const tpl = document.getElementById(t.id);
      const html = tpl.innerHTML; // contains full HTML for srcdoc
      frame.srcdoc = html;
      status.innerHTML = `Running <b>${t.label}</b> (${i+1} / ${tasks.length})`;
      bar.style.width = `${(i) / tasks.length * 100}%`;
    }

    function nextTask() {
      idx++;
      if (idx < tasks.length) {
        loadTask(idx);
      } else {
        status.innerHTML = `<b>All tasks completed.</b> You may close this window.`;
        bar.style.width = '100%';
        frame.srcdoc = `<html><body style="display:grid;place-items:center;min-height:80vh;background:#0b1020;color:#e5e7eb;font-family:system-ui,Segoe UI,Arial">
          <div style="text-align:center">
            <h2>✅ Experiment Complete</h2>
            <p>Thank you! All six tasks have been finished in the requested order.</p>
          </div>
        </body></html>`;
      }
    }

    window.addEventListener('message', (ev) => {
      if (ev && ev.data && ev.data.type === 'taskComplete') {
        // small delay for visual continuity
        setTimeout(() => nextTask(), 400);
      }
    });

    startBtn.addEventListener('click', () => {
      startBtn.disabled = true;
      nextTask();
    });
  </script>
</body>
</html>
